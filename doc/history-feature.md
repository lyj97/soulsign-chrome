# 执行历史记录功能

## 功能概述

执行历史记录功能为魂签（SoulSign）插件增加了完整的任务执行追踪能力，包括：

- **登录检查历史**：记录每次登录状态检查的结果、耗时、日志等
- **签到执行历史**：记录每次签到操作的成功/失败状态、返回值、错误信息等  
- **详细日志**：保存执行过程中的详细日志信息
- **统计分析**：提供成功率、失败次数等统计数据
- **数据导出**：支持历史记录的导出和导入

## 数据结构

### 历史记录对象 (TaskHistory)
```typescript
interface TaskHistory {
    id: string;           // 唯一标识
    taskName: string;     // 任务名称 (author/name)
    type: 'check'|'run';  // 操作类型：登录检查或签到执行
    timestamp: number;    // 执行时间戳
    success: boolean;     // 是否成功
    result: string;       // 返回结果/错误信息
    logs: string[];       // 执行日志数组
    duration: number;     // 执行耗时(毫秒)
    params?: any;         // 执行参数（敏感信息已过滤）
    error?: string;       // 错误堆栈信息
}
```

### 配置选项
```javascript
{
    enableLogging: true,  // 是否启用历史记录
    maxDays: 30,         // 保留最近30天的记录
    maxRecords: 1000     // 每个任务最多保留1000条记录
}
```

## API 接口

### 后端接口

#### 获取配置
- `history/config` - 获取历史记录配置
- `history/config/set` - 保存历史记录配置

#### 历史记录操作  
- `history/list` - 获取历史记录列表（支持分页、过滤、排序）
- `history/stats` - 获取统计信息
- `history/export` - 导出历史记录
- `history/clear` - 清空历史记录

### 核心功能函数

#### 添加历史记录
```javascript
import {addHistory} from '@/backend/history';

await addHistory(taskName, 'run', true, '签到成功', {
    duration: 1500,
    logs: ['开始签到', '获取token', '发送签到请求', '签到成功'],
    params: {username: '***'},
    error: null
});
```

#### 查询历史记录
```javascript
import {getTaskHistory} from '@/backend/history';

const history = await getTaskHistory('作者/任务名', {
    limit: 50,
    type: 'run',
    success: true
});
```

## 使用说明

### 查看历史记录

1. 打开扩展的选项页面
2. 点击顶部导航栏的"执行历史"按钮
3. 可以看到所有任务的执行历史记录

### 过滤功能

- **按任务过滤**：选择特定任务查看其历史
- **按类型过滤**：区分"登录检查"和"签到执行"
- **按状态过滤**：查看成功或失败的记录
- **按时间过滤**：查看最近N天的记录

### 统计信息

在历史页面顶部会显示：
- 总记录数
- 成功/失败次数
- 成功率
- 登录检查次数
- 签到执行次数

### 详情查看

点击任意记录的"详情"按钮可以查看：
- 详细的执行日志
- 错误堆栈信息
- 执行参数（敏感信息已脱敏）
- 返回结果的完整内容

### 数据管理

#### 导出历史记录
1. 在历史页面点击"导出"按钮
2. 会下载JSON格式的历史记录文件
3. 可以导出全部或按条件过滤的记录

#### 清空历史记录  
1. 点击"清空"按钮可以删除所有历史记录
2. 此操作不可撤销，请谨慎使用

#### 配置设置
点击"设置"按钮可以配置：
- 是否启用历史记录功能
- 历史记录保留天数
- 每个任务的最大记录数

## 隐私保护

- **参数脱敏**：自动过滤密码、token等敏感信息
- **本地存储**：所有数据仅存储在本地，不会上传到服务器
- **数据清理**：支持按时间自动清理旧记录

## 性能优化

- **异步记录**：历史记录操作不会阻塞主要功能
- **存储优化**：使用Chrome本地存储API，性能良好
- **自动清理**：防止历史记录占用过多存储空间

## 故障排除

### 历史记录不显示
1. 检查是否启用了历史记录功能
2. 确认任务是否有执行活动
3. 查看浏览器控制台是否有错误

### 存储空间不足
1. 减少保留天数设置
2. 降低每个任务的最大记录数
3. 手动清理旧的历史记录

### 导出功能异常
1. 检查浏览器是否允许下载
2. 确认有足够的磁盘空间
3. 尝试导出较小的数据集

## 更新历史

- **v1.0** - 基础历史记录功能
  - 支持登录检查和签到执行的历史记录
  - 提供Web界面查看和管理
  - 支持数据导出和统计分析

## 技术实现

### 存储架构
- 使用Chrome Extension Storage API
- 每个任务单独存储历史记录
- 存储键格式：`history_{author}_{name}`

### 数据流程
1. 任务执行时调用`addHistory()`记录开始
2. 执行完成后记录结果、日志、耗时等
3. 自动清理超过保留期的旧记录
4. 通过API接口向前端提供数据

### 前端实现
- Vue.js组件化界面
- 支持实时过滤、排序、分页
- 响应式设计，适配不同屏幕尺寸
